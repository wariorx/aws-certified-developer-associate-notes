# X-Ray
* Service that collects data about requests that your application serves and provides tools to view, filter, and gain insights
* Identify issues and opportunities for optimization
* Trace requests across services and gain additional insight on AWS resource performance

## Concepts
* **Segments**: unit of data sent by a compute resource to X-Ray. These record data about the application and request (often from headers)
  * Host (name, alias, or IP) - if forwarded X-Ray will use X-Forwarded-For
  * Request
  * Response
  * Work done
  * Issues (if any)
* **Subsegments**: breakdown of the work done in a segment to provide more granular information and details about the downstream calls made to fulfill the original request. They represent the application view of a call to a downstream client 
  * For services that don't generate their own segments, X-Ray can infer these from downstream nodes such as Dynamodb
  * For services that generate their own segments, segment data will be used
* **Service graphs**: generated from data applications send to X-Ray. Each resource sending data will appear as a Service in X-Ray graphs; with edges symbolizing services that work together to serve requests.
  * In distributed applications, X-Ray combines nodes from all services that process requests with the same trace ID into a single service graph
  * The first service that hits a requests adds a **tracing header**
* **Traces**: Collects all segments generated by a single request identified by a **trace ID**. The first service that the request reaches will generated and append a trace id header to the request; and this will be propagated to downstream services.
* **Sampling**: Algorithm applied to determine a cost-efficient way to determine which requests to track. By default, **first request each second, and 5% of any additional requests** When debugging, you can change the rate to be 100%, or if production requires more frequent logging you could change it to 50%
* **Tracing header**: sampling decision (decided by sampling rules) and trace ID are added to http requests using the **X-Amzn-Trace-Id** header, which is added by the first X-Ray-integrated service that the request hits: `X-Amzn-Trace-Id: Root=1-5759e988-bd862e3fe1be46a994272793;Sampled=1`
  * The header may also include a **parent segment ID** if the request originated from an instrumented application. Downstream applications can use the parent segment ID to connect 2 requests together (IE client-web_server connect to web_server-other_web_server): `X-Amzn-Trace-Id: Root=1-5759e988-bd862e3fe1be46a994272793;Parent=53995c3f42cd8ad8;Sampled=1`
  * **Lineage** may be appended to the trace header by Lambda and other AWS services as part of their processing mechanisms - not to be used directuly in SDK calls: `X-Amzn-Trace-Id: Root=1-5759e988-bd862e3fe1be46a994272793;Sampled=1;Lineage=a87bd80c:1|68fd508a:5|c512fbe3:2`
* **Sampling Rules**: defined in the X-Ray console; they determin which requests to record. By default, the **first request each second, and 5% of any additional requests** accross all services semdomg traces will ne recprded. This can be manually configured but will incur additional charges.
```json
{
  "version": 2,
  "rules": [
    {
      "description": "Player moves.",
      "host": "*",
      "http_method": "*",
      "url_path": "/api/move/*",
      "fixed_target": 0,
      "rate": 0.05
    }
  ],
  "default": {
    "fixed_target": 1,
    "rate": 0.1
  }
}
```
  * Sampling rule changes require code redeployment in addition to changes in the X-Ray console
  * **Reservoir**: indicates how many requests to record per second, spread accross all services instrumented within the same rule
  * **Rate**: indicates additional % of requests to record AFTER the reservoir has been exhausted
* **Filter expressions**: X-Ray console provides a view of the service graph - it shows health and performance information that helps identify issues and optimization opportunities - filter expressions such as `http.url CONTAINS "api/move"` can be used to focus specific requests
* **Groups**: fitler expressins can be ysed as criteris to **accept traces into a group**, which contains its own service graph, trace summaries, and CloudWatch metrics.
* **Annotations and metadata**: by default, X-Ray SDK records information about incoming and outgoin requests, the AWS resources used, and the application itself. Additional information can be added to a **segment** in the form of annotations and metafata
  * **Annotations**: key-valye pairs that are indexed to be used with **filter expressions**. use for data that you want to add yo a group trace - up to 50 per trace
  * **Metadata** key-value pairs with values of any type (obj, lists, etc), not indexed. use to record data that you want to **store in a trace byt don't need to use for searches or filtering**
* **Errors, faults, and exceptions**: X-Ray records errors in the application code:
  * **Error**: HTTP 400s
  * **Fault**: Http 500s
  * **Throttle**: 429 Too Many Requests
## Instrumentation
* Sending trace data for incoming and outgoing requests and events within an application, along with metadata about those requests.
* Types
  * **Auto instrumentation**: configuration changes and usage of an instrumentation agent
  * **Library instrumentation**: make code changes to include libraries which automatically perform API calls usually though an SDK
  * **Manual instrumentation**: manually make instrumentation calls in the code
* X-Ray supports both Open Telemetry and X-Ray SDK instrumentation. Chose one or the other based on the requirements
  * OpenTelemetry:
    * Interact with multiple tracing backends
    * Support a large number of library instrumentations for each language
    * Lambdas that manage telemetry data collection
  * X-Ray SDK:
    * Tightly integrates vendor solutions
    * Integration with X-Ray sampling rules and ability to configure sampling rules from the console
* Example IAM permissions for SDK-integrated service:
  ```json
  {
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "xray:PutTraceSegments",
                "xray:PutTelemetryRecords",
                "xray:GetSamplingRules",
                "xray:GetSamplingTargets"
            ],
            "Resource": [
                "*"
            ]
        }
    ]
  }
  ```

